---
// src/pages/admin/zones/index.astro
import Nav from "../../components/utils/Nav.astro";
import "/src/styles/global.css";

// 1. Preparamos la configuración de Firebase para el cliente
const clientSideFirebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
    authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
    projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
    appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
};
---

<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gestionar Zonas</title>
    </head>
    <body>
        <Nav currentPage="zones" />

        <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2
                class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 mt-8"
            >
                Gestionar Zonas
            </h2>
            <a href="/admin/zones/new" class="inline-block mb-8">
                <button
                    type="button"
                    class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                >
                    Crear Zona
                </button>
            </a>

            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                <table
                    class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400"
                >
                    <thead
                        class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
                    >
                        <tr>
                            <th scope="col" class="px-6 py-3"> Título (ES) </th>
                            <th scope="col" class="px-6 py-3"> Publicado </th>
                            <th scope="col" class="px-6 py-3"> Acciones </th>
                        </tr>
                    </thead>
                    <tbody id="zones-table-body">
                        <tr>
                            <td colspan="3" class="px-6 py-4 text-center"
                                >Cargando zonas...</td
                            >
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <script
            type="module"
            define:vars={{ firebaseConfig: clientSideFirebaseConfig }}
        >
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
            import {
                getAuth,
                onAuthStateChanged,
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const tableBody = document.getElementById("zones-table-body");

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const idToken = await user.getIdToken();
                        const response = await fetch("/api/zones", {
                            // <-- Llama a la API de zonas
                            headers: { Authorization: `Bearer ${idToken}` },
                        });

                        if (!response.ok) {
                            throw new Error(
                                "La respuesta del servidor no fue OK",
                            );
                        }
                        const zones = await response.json();

                        tableBody.innerHTML = "";
                        if (zones.length === 0) {
                            tableBody.innerHTML =
                                '<tr><td colspan="3" class="px-6 py-4 text-center">No hay zonas creadas.</td></tr>';
                        } else {
                            zones.forEach((zone) => {
                                const row = document.createElement("tr");
                                row.className =
                                    "bg-white border-b dark:bg-gray-800 dark:border-gray-700";
                                const pubDate = new Date(
                                    zone.pubDate,
                                ).toLocaleDateString("es-ES");
                                row.innerHTML = `
                                <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${zone.translations?.es?.title || "Sin título"}</td>
                                <td class="px-6 py-4">${pubDate}</td>
                                <td class="px-6 py-4">
                                    <a href="/admin/zones/edit/${zone.id}" class="font-medium text-blue-600 hover:underline">Editar</a>
                                </td>
                            `;
                                tableBody.appendChild(row);
                            });
                        }
                    } catch (error) {
                        console.error("Error al cargar zonas:", error);
                        tableBody.innerHTML =
                            '<tr><td colspan="3" class="px-6 py-4 text-center">Error al cargar las zonas.</td></tr>';
                    }
                } else {
                    window.location.href = "/admin/login";
                }
            });
        </script>
    </body>
</html>
